!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).YoutubeExternalSubtitle=t()}(this,(function(){"use strict";var e=function(){return(e=Object.assign||function(e){for(var t,n=1,i=arguments.length;n<i;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)},t=new(function(){function e(){this.window=null,this.document=null,this.YT=null,this.initService=null}return e.prototype.setWindow=function(e){this.window=e},e.prototype.getWindow=function(){return this.window},e.prototype.setDocument=function(e){this.document=e},e.prototype.getDocument=function(){return this.document},e.prototype.setYT=function(e){this.YT=e},e.prototype.getYT=function(){return this.YT},e.prototype.setInitService=function(e){this.initService=e},e.prototype.getInitService=function(){return this.initService},e}()),n="youtube-external-subtitle-style",i="youtube-external-subtitle",r="fullscreen",o="fullscreen-ignore",l=function(e){for(var t=e.getElementsByClassName(i),n=[],r=0;r<t.length;r++)n.push(t[r].youtubeExternalSubtitle);return n},s=function(){for(var e=t.getDocument(),n=function(e){return e.fullscreenElement||e.webkitFullscreenElement||e.webkitCurrentFullScreenElement||e.mozFullScreenElement||e.msFullscreenElement}(e),i=!!n,r=function(e){if(!e)return null;if(e.youtubeExternalSubtitle)return e.youtubeExternalSubtitle;var t=l(e);return t.length>0?t[0]:null}(n),o=0,s=l(e);o<s.length;o++){var a=s[o];a.setIsFullscreenActive(i?r===a:null)}},a=function(){function e(){}return e.prototype.grantIframeApi=function(e){if(null===t.getYT()){var n=t.getWindow(),i=t.getDocument();!function(e,t){if(e())t();else var n=setInterval((function(){e()&&(clearInterval(n),t())}),100)}((function(){return function(e){return!(!e.YT||!e.YT.Player)}(n)}),(function(){t.setYT(n.YT),e()})),function(e){(function(e){for(var t=e.getElementsByTagName("script"),n=0;n<t.length;n++){var i=t[n].src;if(i&&-1!==i.indexOf("youtube.com/iframe_api"))return!0}return!1})(e)||function(e){var t=e.createElement("script");t.src="https://www.youtube.com/iframe_api";var n=e.getElementsByTagName("script")[0];n.parentNode.insertBefore(t,n)}(e)}(i)}else e()},e.prototype.grantGlobalStyles=function(){var e=t.getDocument();(function(e){return!!e.getElementById(n)})(e)||function(e){var t=e.createElement("style");t.id=n,t.type="text/css",t.innerHTML="\n    ."+i+" { position: absolute; display: none; z-index: 0; pointer-events: none; color: #fff; font-family: Arial, 'Helvetica Neue', Helvetica, sans-serif; font-weight: normal; font-size: 17px; text-align: center; }\n    ."+i+" span { background: #000; background: rgba(0, 0, 0, 0.9); padding: 1px 4px; display: inline-block; margin-bottom: 2px; }\n    ."+i+"."+o+" { display: none !important; }\n    ."+i+"."+r+" { z-index: 3000000000; }\n  ";var l=e.getElementsByTagName("head")[0]||e.documentElement;l.insertBefore(t,l.firstChild),e.addEventListener("fullscreenchange",s),e.addEventListener("webkitfullscreenchange",s),e.addEventListener("mozfullscreenchange",s),e.addEventListener("MSFullscreenChange",s)}(e)},e}(),u=function(e){return Math.floor(e/10)},c=function(e,t){for(var n=[],i=u(t),r=u(e);r<=i;r++)n.push(r);return n},f=function(e,t){var n=e.indexOf("#"),i="";-1!==n&&(i=e.substr(n),e=e.substr(0,n));var r=e.indexOf("?"),o="";-1!==r&&(o=e.substr(r),e=e.substr(0,r));for(var l=0,s=Object.keys(t);l<s.length;l++){var a=s[l];o+=(""===o?"?":"&")+a+"="+t[a]}return""+e+o+i},h=function(){function n(e,n){var i=this;if(void 0===n&&(n=[]),this.cache=null,this.timeChangeInterval=0,this.controlsHideTimeout=0,this.player=null,this.videoId=null,this.element=null,this.state={text:null,isFullscreenActive:null,controlsVisible:!0},this.onTimeChange=function(){var e=function(e,t){if(!t)return null;var n=t[u(e)];if(!n)return null;for(var i=0,r=n;i<r.length;i++){var o=r[i];if(e>=o.start&&e<=o.end)return o}return null}(i.player.getCurrentTime(),i.cache);i.setState({text:e?e.text:null})},this.onControlsHide=function(){i.setState({controlsVisible:!1})},this.onPlayerReady=function(){i.videoId=i.getCurrentVideoId()},this.onPlayerStateChange=function(e){if(i.videoId===i.getCurrentVideoId()){var n=t.getYT();e.data===n.PlayerState.PLAYING?i.start():e.data===n.PlayerState.PAUSED?i.stop():e.data===n.PlayerState.ENDED&&(i.stop(),i.setState({text:null}))}},e.youtubeExternalSubtitle)throw new Error("YoutubeExternalSubtitle: subtitle is already added for this element");e.youtubeExternalSubtitle=this;var r=function(e){var t=e;return-1===t.indexOf("enablejsapi=1")&&(t=f(t,{enablejsapi:"1"})),-1===t.indexOf("html5=1")&&(t=f(t,{html5:"1"})),-1===t.indexOf("playsinline=1")&&(t=f(t,{playsinline:"1"})),-1===t.indexOf("fs=")&&(t=f(t,{fs:"0"})),t}(e.src);e.src!==r&&(e.src=r),this.load(n),this.element=function(e,n){var i=t.getDocument().createElement("div");return i.youtubeExternalSubtitle=n,e.parentNode.insertBefore(i,e.nextSibling),i}(e,this);var o=t.getInitService();o.grantGlobalStyles(),this.render(),o.grantIframeApi((function(){var n=t.getYT();i.player=new n.Player(e),i.player.addEventListener("onReady",i.onPlayerReady),i.player.addEventListener("onStateChange",i.onPlayerStateChange)}))}return n.prototype.load=function(e){this.cache=function(e){for(var t={},n=0,i=e;n<i.length;n++)for(var r=i[n],o=0,l=c(r.start,r.end);o<l.length;o++){var s=l[o];t[s]||(t[s]=[]),t[s].push(r)}return t}(e)},n.prototype.setIsFullscreenActive=function(e){this.setState({isFullscreenActive:e})},n.prototype.destroy=function(){this.stop(),this.element.parentNode.removeChild(this.element),this.player.getIframe().youtubeExternalSubtitle=null,this.player.removeEventListener("onReady",this.onPlayerReady),this.player.removeEventListener("onStateChange",this.onPlayerStateChange)},n.prototype.render=function(){var e,t,n,l,s,a;if(this.element.className=(e=this.state.isFullscreenActive,t=[i],null!==e&&t.push(e?r:o),t.join(" ")),this.element.innerHTML="<span>"+(null===(n=this.state.text)?"":n).replace(/(?:\r\n|\r|\n)/g,"</span><br /><span>")+"</span>",this.element.style.display=null===this.state.text?"":"block",this.player){var u=(l=this.player.getIframe(),s=this.state.controlsVisible,a=l.offsetHeight,{x:l.offsetLeft-l.scrollLeft+l.clientLeft,y:l.offsetTop-l.scrollTop+l.clientTop,width:l.offsetWidth,height:a,bottomPadding:a<200&&!s?20:60});this.element.style.visibility="hidden",this.element.style.top=u.y+"px",this.element.style.left=u.x+"px",this.element.style.maxWidth=u.width-20+"px",this.element.style.fontSize=u.height/260+"em",this.element.style.top=u.y+u.height-u.bottomPadding-this.element.offsetHeight+"px",this.element.style.left=u.x+(u.width-this.element.offsetWidth)/2+"px",this.element.style.visibility=""}},n.prototype.setState=function(t){var n=this.state,i=e(e({},n),t);(function(e,t){for(var n=0,i=Object.keys(t);n<i.length;n++){var r=i[n];if(e[r]!==t[r])return!0}return!1})(n,i)&&(this.state=i,this.render())},n.prototype.start=function(){this.stop();var e=t.getWindow();this.timeChangeInterval=e.setInterval(this.onTimeChange,500),this.controlsHideTimeout=e.setTimeout(this.onControlsHide,3e3)},n.prototype.stop=function(){var e=t.getWindow();e.clearInterval(this.timeChangeInterval),e.clearTimeout(this.controlsHideTimeout),this.setState({controlsVisible:!0})},n.prototype.getCurrentVideoId=function(){return this.player.getVideoData().video_id},n}();return function(e){t.setWindow(e),t.setDocument(e.document),t.setInitService(new a)}(window),{Subtitle:h}}));
